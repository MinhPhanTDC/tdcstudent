rules_version = '2';
// Firebase Storage Security Rules for The Design Council LMS
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin using custom claims (set by Cloud Functions)
    // This is faster and free (no Firestore reads)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    // Fallback: Check Firestore if custom claims not set yet
    // This handles the transition period when claims are being set
    function isAdminFallback() {
      return isAuthenticated() && 
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Combined check: Try custom claims first, fallback to Firestore
    function isAdminWithFallback() {
      return isAdmin() || isAdminFallback();
    }
    
    // Check file size (max 10MB)
    function isValidSize() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // Check if file is an image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Check if file is a PDF
    function isPDF() {
      return request.resource.contentType == 'application/pdf';
    }
    
    // Check if file is a document (PDF, Word, etc.)
    function isDocument() {
      return request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.*');
    }

    // ============================================
    // Handbook Storage (Public Read)
    // ============================================
    match /handbook/{fileName} {
      // Anyone can read handbook files (for login page flipbook)
      allow read: if true;
      
      // Only admins can upload/delete handbook files
      allow write: if isAdmin() && isPDF() && isValidSize();
    }

    // ============================================
    // Course Materials Storage
    // ============================================
    match /courses/{courseId}/{allPaths=**} {
      // Authenticated users can read course materials
      allow read: if isAuthenticated();
      
      // Only admins can upload course materials
      allow write: if isAdmin() && isValidSize();
    }

    // ============================================
    // Student Submissions Storage
    // ============================================
    match /submissions/{studentId}/{allPaths=**} {
      // Students can read their own submissions
      // Admins can read all submissions
      allow read: if isAuthenticated() && 
        (request.auth.uid == studentId || isAdmin());
      
      // Students can upload to their own folder
      // Admins can upload to any folder
      allow write: if isAuthenticated() && 
        (request.auth.uid == studentId || isAdmin()) &&
        isValidSize();
    }

    // ============================================
    // Media Library Storage (Admin Only)
    // ============================================
    match /media/{allPaths=**} {
      // Anyone can read media files (for login backgrounds)
      allow read: if true;
      
      // Only admins can upload media files
      // Uses custom claims (fast) with Firestore fallback (during transition)
      allow create: if isAdminWithFallback() && isValidSize();
      allow update, delete: if isAdminWithFallback();
    }

    // ============================================
    // User Avatars Storage
    // ============================================
    match /avatars/{userId}/{fileName} {
      // Anyone authenticated can read avatars
      allow read: if isAuthenticated();
      
      // Users can upload their own avatar
      // Admins can upload any avatar
      allow write: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin()) &&
        isImage() &&
        request.resource.size < 2 * 1024 * 1024; // Max 2MB for avatars
    }

    // ============================================
    // Temporary Uploads (for processing)
    // ============================================
    match /temp/{userId}/{allPaths=**} {
      // Users can read/write their own temp files
      allow read, write: if isAuthenticated() && 
        request.auth.uid == userId &&
        isValidSize();
    }

    // ============================================
    // Default: Deny all other access
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
